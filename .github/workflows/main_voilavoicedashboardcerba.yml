# Build and Deploy Next.js Docker Container to Azure Web App
# App Service: voilavoicedashboardcerba
# Docker Hub: rudyimhtpdev/voilavoicedashboard

name: Build and deploy Docker container to Azure Web App - voilavoicedashboardcerba

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: rudyimhtpdev/voilavoicedashboard
  AZURE_WEBAPP_NAME: voilavoicedashboardcerba1
  RESOURCE_GROUP: voiladashboard1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            NEXT_PUBLIC_SUPABASE_URL=https://yxqconubtqdskcxiobsp.supabase.co
            NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cWNvbnVidHFkc2tjeGlvYnNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjMzNzYsImV4cCI6MjA3ODkzOTM3Nn0.-JnEq6PTC-xvYL6ePSVcCdQoYMU6gIlgsR6z5fSI63Y
            NEXT_PUBLIC_CHAT_PROVIDER=vapi
            NEXT_PUBLIC_PIPECAT_CHAT_API_URL=https://20.199.66.239.nip.io/api
            NEXT_PUBLIC_PIPECAT_CHAT_WS_URL=wss://20.199.66.239.nip.io/ws
            VAPI_API_KEY=${{ secrets.VAPI_API_KEY }}
            VAPI_ASSISTANT_ID=${{ secrets.VAPI_ASSISTANT_ID }}
            VAPI_CHAT_URL=https://api.vapi.ai/chat

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure Web App to use Docker
        run: |
          # Set container image
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --docker-custom-image-name ${{ env.DOCKER_IMAGE }}:latest \
            --docker-registry-server-url https://index.docker.io/v1

          # Set environment variables for Supabase, Pipecat, and Vapi Chat
          az webapp config appsettings set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              NEXT_PUBLIC_SUPABASE_URL="https://yxqconubtqdskcxiobsp.supabase.co" \
              NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4cWNvbnVidHFkc2tjeGlvYnNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjMzNzYsImV4cCI6MjA3ODkzOTM3Nn0.-JnEq6PTC-xvYL6ePSVcCdQoYMU6gIlgsR6z5fSI63Y" \
              NEXT_PUBLIC_CHAT_PROVIDER="vapi" \
              NEXT_PUBLIC_PIPECAT_CHAT_API_URL="https://20.199.66.239.nip.io/api" \
              NEXT_PUBLIC_PIPECAT_CHAT_WS_URL="wss://20.199.66.239.nip.io/ws" \
              VAPI_API_KEY="${{ secrets.VAPI_API_KEY }}" \
              VAPI_ASSISTANT_ID="${{ secrets.VAPI_ASSISTANT_ID }}" \
              VAPI_CHAT_URL="https://api.vapi.ai/chat" \
              WEBSITES_PORT=3000 \
              DOCKER_ENABLE_CI=true

      - name: Restart Azure Web App
        run: |
          az webapp restart \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }}

      - name: Verify deployment
        run: |
          echo "‚úÖ Docker container deployed successfully!"
          echo "üê≥ Docker Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "üåê Dashboard URL: https://voilavoicedashboardcerba1-gaafdfhpawcwa5ek.francecentral-01.azurewebsites.net/login"
          echo ""
          echo "üìù Next steps:"
          echo "1. Wait 2-3 minutes for container to start"
          echo "2. Check Azure Portal logs if needed"
          echo "3. Test login functionality"
